<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Rhpc">
<title>Breakpoint example • Rhpc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Breakpoint example">
<meta property="og:description" content="Rhpc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">Rhpc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/breakpt-ex.html">Breakpoint example</a>
    <a class="dropdown-item" href="../articles/neovim-ide.html">Neovim as IDE</a>
    <a class="dropdown-item" href="../articles/quickstart.html">Quick Start</a>
    <a class="dropdown-item" href="../articles/workflows.html">Workflows</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mschubert/R-hpc/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Breakpoint example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mschubert/R-hpc/blob/HEAD/vignettes/breakpt-ex.Rmd" class="external-link"><code>vignettes/breakpt-ex.Rmd</code></a></small>
      <div class="d-none name"><code>breakpt-ex.Rmd</code></div>
    </div>

    
    
<style type="text/css">
img {
    border: 0px !important;
    margin: 2em 2em 2em 2em !important;
}
code {
    border: 0px !important;
}
kbd {
    background-color: #eee;
    border-radius: 3px;
    border: 1px solid #b4b4b4;
    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;
    color: #333;
    display: inline-block;
    font-size: .85em;
    font-weight: 700;
    line-height: 1;
    padding: 2px 4px;
    white-space: nowrap;
}
</style>
<div class="section level2">
<h2 id="change-points-in-a-time-course">Change points in a time course<a class="anchor" aria-label="anchor" href="#change-points-in-a-time-course"></a>
</h2>
<p>In order to not only use <code><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep()</a></code> but do some actual computations, we chose as a toy problem the inference of change points in a time course with repeated observations of the same measurement. First, we will start off with simulating data that has an increasing integer <code>x</code> coordinate (time point) and a continuous <code>y</code> coordinate (observation value).</p>
<p>We will then use the <code>mcp</code> package to detect a point in <code>x</code> where the value of <code>y</code> changes abruptly. This package is able to infer many different kinds of change points. Here, we make use of changing intercepts with constant, normally distributed noise. The package is built on <code>rjags</code>, which uses a Gibbs sampling Markov-Chain Monte Carlo (MCMC).</p>
<p>These computations are usually computationally expensive, but the individual sampling chains are independent of each other. This makes this kind of problem amenable to extensive parallelization.</p>
<p>Fortunately, the <code>rjags</code> package is already provided as a module, so we can load it using the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load rjags/4-10-R-4.1.2</span></code></pre></div>
<p>After running this, it should be available from within R via <code><a href="https://mcmc-jags.sourceforge.io" class="external-link">library(rjags)</a></code>. We still need to <code>install.packages("mcp")</code>, but as this does not require external tools it should work without issues. Note that the system-wide R package library is not writable for individual users, so you have to use your user library in your home directory (R will prompt you to do this).</p>
</div>
<div class="section level2">
<h2 id="creating-a-function-to-simulate-data">Creating a function to simulate data<a class="anchor" aria-label="anchor" href="#creating-a-function-to-simulate-data"></a>
</h2>
<p>We can use the following function to simulate our data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># simulate one data set with random break points and y coordinates</span>
<span class="va">simulate_data</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">len</span><span class="op">=</span><span class="fl">1000</span>, <span class="va">bps</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">bp</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">bps</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">loc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
        <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">loc</span><span class="op">:</span><span class="va">len</span><span class="op">]</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">loc</span><span class="op">:</span><span class="va">len</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">sim</span>
<span class="op">}</span></code></pre></div>
<p>This will randomly generate one sample with our <code>x</code> and <code>y</code> coordinates. The resulting data should look something like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim</span> <span class="op">=</span> <span class="fu">simulate_data</span><span class="op">(</span>bps<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></code></pre></div>
<p><img src="breakpt-ex_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dev.off()  # close the device to complete the plot</span></code></pre></div>
<p>On Sulis, the plot will be saved as <code>Rplots.pdf</code>.</p>
</div>
<div class="section level2">
<h2 id="running-break-point-inference">Running break point inference<a class="anchor" aria-label="anchor" href="#running-break-point-inference"></a>
</h2>
<p>We can now use our simulated data as a starting point to infer the breakpoints that we simulated. Using the <code>mcp</code> package, we run three different models:</p>
<ul>
<li>One segment, no breakpoints</li>
<li>Two segments, one breakpoint</li>
<li>Three segments, two breakpoints</li>
</ul>
<p>When then compare these models in terms of how well they fit the data, and return the model that fits best:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lindeloev.github.io/mcp/" class="external-link">mcp</a></span><span class="op">)</span>

<span class="va">run_mcp</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># one unbroken segment, 2 segments with one break point, 3 segments 2 bps</span>
    <span class="va">mods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># fit all three models, select the best using leave-one-out</span>
    <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu">mcp</span><span class="fu">::</span><span class="fu"><a href="https://lindeloev.github.io/mcp/reference/mcp.html" class="external-link">mcp</a></span><span class="op">(</span><span class="va">m</span>, data<span class="op">=</span><span class="va">sim</span>, par_x<span class="op">=</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">compare</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="fu">mcp</span><span class="fu">::</span><span class="va"><a href="https://lindeloev.github.io/mcp/reference/criterion.html" class="external-link">loo</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">compare</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">fits</span><span class="op">[[</span><span class="va">best</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span></code></pre></div>
<p>The resulting model should look something like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">=</span> <span class="fu">run_mcp</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 1000</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 2</span>
<span class="co">#&gt;    Total graph size: 5019</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; Finished sampling in 18.7 seconds</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 1000</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 4</span>
<span class="co">#&gt;    Total graph size: 12020</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; Finished sampling in 81.5 seconds</span>
<span class="co">#&gt; Compiling model graph</span>
<span class="co">#&gt;    Resolving undeclared variables</span>
<span class="co">#&gt;    Allocating nodes</span>
<span class="co">#&gt; Graph information:</span>
<span class="co">#&gt;    Observed stochastic nodes: 1000</span>
<span class="co">#&gt;    Unobserved stochastic nodes: 6</span>
<span class="co">#&gt;    Total graph size: 17028</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Initializing model</span>
<span class="co">#&gt; Finished sampling in 152 seconds</span>
<span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>

<span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span>
<span class="fu"><a href="https://lindeloev.github.io/mcp/reference/plot.mcpfit.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
<p><img src="breakpt-ex_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dev.off()  # close the device to complete the plot</span></code></pre></div>
<p>Here, we see the <code>x</code> and <code>y</code> coordinates of our observations as before, but in addition we see the traces of the intercepts (grey lines) and the probability density of the break point itself (blue line close to the bottom of the plot).</p>
<div class="section level4">
<h4 id="exercise">Exercise<a class="anchor" aria-label="anchor" href="#exercise"></a>
</h4>
<ul>
<li>Use your editor to create the break point simulation script (<em>hint</em>: you can use <kbd>Esc</kbd>+<code>:set paste</code> in nvim to copy-paste the text without automatic indentation and <code>:set nopaste</code> to return)</li>
<li>Start an interactive job with 1 task and 5 cores</li>
<li>Simulate data for one and two break points</li>
<li>Run the <code>mcp</code> inference script to try to estimate the breakpoints from the data. Do they match to the parameters of your simulation? (<em>hint</em>: you can use the <code>plot</code> function on a <code>mcp</code> model object; this will create a <code>Rplots.pdf</code> after which you’ll need to <code><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off()</a></code> and copy to your local machine)</li>
<li>Which options do you see to make this code run faster? (<em>hint</em>: there is both <code>mcp</code>-provided parallelism and sequential steps in the inference code)</li>
<li>How much runtime can you save by running computations in parallel?</li>
</ul>
<details><summary>
Solution
</summary><p>Start the interactive job using:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--account</span> su105 <span class="at">--ntasks</span><span class="op">=</span>1 <span class="at">--cpus-per-task</span><span class="op">=</span>5 <span class="at">--time</span> 6:00:00 <span class="at">--pty</span> <span class="va">$SHELL</span></span></code></pre></div>
<p>In <code>nvim</code> create the file <em>compute_breakpt.r</em>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lindeloev.github.io/mcp/" class="external-link">mcp</a></span><span class="op">)</span>
<span class="va">simulate_data</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">len</span><span class="op">=</span><span class="fl">1000</span>, <span class="va">bps</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">bp</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">bps</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">loc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
        <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">loc</span><span class="op">:</span><span class="va">len</span><span class="op">]</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">loc</span><span class="op">:</span><span class="va">len</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">sim</span>
<span class="op">}</span>

<span class="va">run_mcp</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># one unbroken segment, 2 segments with one break point, 3 segments 2 bps</span>
    <span class="va">mods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># fit all three models, select the best using leave-one-out</span>
    <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu">mcp</span><span class="fu">::</span><span class="fu"><a href="https://lindeloev.github.io/mcp/reference/mcp.html" class="external-link">mcp</a></span><span class="op">(</span><span class="va">m</span>, data<span class="op">=</span><span class="va">sim</span>, par_x<span class="op">=</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">compare</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="fu">mcp</span><span class="fu">::</span><span class="va"><a href="https://lindeloev.github.io/mcp/reference/criterion.html" class="external-link">loo</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">compare</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">fits</span><span class="op">[[</span><span class="va">best</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">run_mcp_fast</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># one unbroken segment, 2 segments with one break point, 3 segments 2 bps</span>
    <span class="va">mods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># fit all three models, select the best using leave-one-out</span>
    <span class="va">fits</span> <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu">mcp</span><span class="fu">::</span><span class="fu"><a href="https://lindeloev.github.io/mcp/reference/mcp.html" class="external-link">mcp</a></span><span class="op">(</span><span class="va">m</span>, data<span class="op">=</span><span class="va">sim</span>, par_x<span class="op">=</span><span class="st">"x"</span>, cores<span class="op">=</span><span class="fl">3L</span><span class="op">)</span><span class="op">)</span>
<span class="co">#          ^^^^^^^^^^^^^^^^^^                                                    ^^^^^^^^</span>
    <span class="va">compare</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="fu">mcp</span><span class="fu">::</span><span class="va"><a href="https://lindeloev.github.io/mcp/reference/criterion.html" class="external-link">loo</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#                                            ^^^^^^^^^^^^^^^^^^</span>
    <span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">compare</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">fits</span><span class="op">[[</span><span class="va">best</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">one_bp</span> <span class="op">=</span> <span class="fu">simulate_data</span><span class="op">(</span>bps<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="va">two_bp</span> <span class="op">=</span> <span class="fu">simulate_data</span><span class="op">(</span>bps<span class="op">=</span><span class="fl">2</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">r1</span> <span class="op">=</span> <span class="fu">run_mcp</span><span class="op">(</span><span class="va">one_bp</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">r2</span> <span class="op">=</span> <span class="fu">run_mcp_fast</span><span class="op">(</span><span class="va">one_bp</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">r3</span> <span class="op">=</span> <span class="fu">run_mcp</span><span class="op">(</span><span class="va">two_bp</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="va">r4</span> <span class="op">=</span> <span class="fu">run_mcp_fast</span><span class="op">(</span><span class="va">two_bp</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"breakpts.pdf"</span><span class="op">)</span>
<span class="fu"><a href="https://lindeloev.github.io/mcp/reference/plot.mcpfit.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r1</span><span class="op">)</span>
<span class="fu"><a href="https://lindeloev.github.io/mcp/reference/plot.mcpfit.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span>
<span class="fu"><a href="https://lindeloev.github.io/mcp/reference/plot.mcpfit.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r3</span><span class="op">)</span>
<span class="fu"><a href="https://lindeloev.github.io/mcp/reference/plot.mcpfit.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r4</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We also see that <code>run_mcp_fast</code> is not 9 times as fast, but gets slowed down by (1) higher run times for more complex models, and (2) only the 5 cores we requested.</p>
<p>In general, we want to avoid “oversubscribing” the cores we have requested because they will ultimately run slower than if we use what we request.</p>
</details>
</div>
</div>
<div class="section level2">
<h2 id="bigger-data-sets">Bigger data sets<a class="anchor" aria-label="anchor" href="#bigger-data-sets"></a>
</h2>
<p>The strategy of reserving a node with many CPUs works well up to the extent where we want to process more computations in parallel than there are CPUs on a given node (modern nodes often have up to 128 cores/threads).</p>
<p>Here, we want to simulate such a big computational task, but for this to not use too many resources we will limit the overall amount.</p>
<div class="section level4">
<h4 id="exercise-1">Exercise<a class="anchor" aria-label="anchor" href="#exercise-1"></a>
</h4>
<ul>
<li>Simulate 10 breakpoint data sets using the function above, and save the resulting list in an <code>.rds</code> object (using <code>saveRDS</code>)</li>
<li>Write a submission script with 10 tasks that load the object, subset the current task index, and save the resulting model as <code>.rds</code> and model plot as <code>.pdf</code> (<em>hint</em>: there are automatic environment variables available for each Slurm run, such as <a href="https://slurm.schedmd.com/sbatch.html#lbAK" class="external-link"><code>SLURM_PROCID</code></a>)</li>
</ul>
<details><summary>
Solution simulation
</summary><p><em>sim_breakpt.r</em></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulate_data</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">len</span><span class="op">=</span><span class="fl">1000</span>, <span class="va">bps</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">bp</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">bps</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">loc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
        <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">loc</span><span class="op">:</span><span class="va">len</span><span class="op">]</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">loc</span><span class="op">:</span><span class="va">len</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">sim</span>
<span class="op">}</span>

<span class="va">sims</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span>, simplify<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">sims</span>, file<span class="op">=</span><span class="st">"sim_breakpt.rds"</span><span class="op">)</span></code></pre></div>
</details><details><summary>
Solution breakpoint inference
</summary><p><em>submit_breakpt.sh</em></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --account su105</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --partition compute</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --ntasks 10</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task 1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem 2048M</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time 8:00:00</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> Rscript compute_breakpt_manual.r</span></code></pre></div>
<p><em>compute_breakpt_manual.r</em></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lindeloev.github.io/mcp/" class="external-link">mcp</a></span><span class="op">)</span>

<span class="va">run_mcp</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># one unbroken segment, 2 segments with one break point, 3 segments 2 bps</span>
    <span class="va">mods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># fit all three models, select the best using leave-one-out</span>
    <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu">mcp</span><span class="fu">::</span><span class="fu"><a href="https://lindeloev.github.io/mcp/reference/mcp.html" class="external-link">mcp</a></span><span class="op">(</span><span class="va">m</span>, data<span class="op">=</span><span class="va">sim</span>, par_x<span class="op">=</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">compare</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="fu">mcp</span><span class="fu">::</span><span class="va"><a href="https://lindeloev.github.io/mcp/reference/criterion.html" class="external-link">loo</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">compare</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">fits</span><span class="op">[[</span><span class="va">best</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">idx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SLURM_PROCID"</span><span class="op">)</span> <span class="co"># zero-indexed</span>

<span class="va">dset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"sim_breakpt.rds"</span><span class="op">)</span>
<span class="va">cur_dset</span> <span class="op">=</span> <span class="va">dset</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># one-indexed</span>

<span class="va">res</span> <span class="op">=</span> <span class="fu">run_mcp</span><span class="op">(</span><span class="va">cur_dset</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bp"</span>, <span class="va">idx</span>, <span class="st">".pdf"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">res</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bp"</span>, <span class="va">idx</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</details>
</div>
</div>
<div class="section level2">
<h2 id="hpc-specific-packages">HPC-specific packages<a class="anchor" aria-label="anchor" href="#hpc-specific-packages"></a>
</h2>
<p>There are also multiple packages available to make use of HPC resources from within R. That is to say, that R will submit a job or multiple jobs, and retrieve the result back to the session.</p>
<p>There are, for instance, the packages <code>BatchJobs</code> and <code>batchtools</code>. These make use of the networked file system to write each call and its arguments to a file, that is then retrieved by the job and executed. These packages are robust for small numbers of jobs, however, they will put a substantial strain on the file system for a high number of function calls.</p>
<p>Instead, we will introduce two packages that make only little use of the shared file system, <code>slurmR</code> and <code>clustermq</code>. (Note that I am the author of the latter, so there’s a bit of a conflict of interest here.)</p>
<p>There is also the <a href="https://cran.r-project.org/package=Rmpi" class="external-link"><code>Rmpi</code></a> package, which provides an R cluster object for e.g. <code>parLapply</code> of multiple instances communicating over different nodes. There is an example on the <a href="https://sulis-hpc.github.io/gettingstarted/batchq/mpi#parallel-cluster-in-r" class="external-link">Sulis docs</a>, however, it requires additional setup in the job submission script.</p>
<div class="section level4">
<h4 id="slurmr">slurmR<a class="anchor" aria-label="anchor" href="#slurmr"></a>
</h4>
<p>The <a href="https://uscbiostats.github.io/slurmR/" class="external-link"><code>slurmR</code></a> package is a lightweight (dependency-free) R package that allows users to interact with the scheduler.</p>
<p>It can be used to create a cluster object on Slurm tasks analogous to <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makePSOCKcluster</a></code>. We do <em>not need</em> a separate submission script, but should run it in an interactive job to not strain the login node. The command for this is <code>slurmR::makeSlurmCluster(ntasks)</code>, which can then be used with the <code>parLapply</code> or <code>parSapply</code> functions:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("slurmR") if you have not installed the package yet</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/USCbiostats/slurmR" class="external-link">slurmR</a></span><span class="op">)</span>

<span class="va">cl</span> <span class="op">=</span> <span class="fu">makeSlurmCluster</span><span class="op">(</span><span class="fl">5</span>, account<span class="op">=</span><span class="st">"su105"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span> <span class="fu">parSapply</span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>

<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></code></pre></div>
<p>The <code>sbatch</code> call that is created via <code>makeSlurmCluster</code> can be customized by passing different parameters to the cluster creation function. In particular, we need to:</p>
<ul>
<li>Include the right budgeting account</li>
</ul>
<p>The jobs started automatically by slurmR will not inherit the same environment used in your interactive job. This will not be a problem if you’ve added module comamnds to your <code>.bashrc</code> file as in the previous exercises.</p>
<p>More details can be found in their <a href="https://uscbiostats.github.io/slurmR/articles/getting-started.html" class="external-link">Getting Started vignette</a>.</p>
</div>
<div class="section level4">
<h4 id="clustermq">clustermq<a class="anchor" aria-label="anchor" href="#clustermq"></a>
</h4>
<p>The <a href="https://mschubert.github.io/clustermq/" class="external-link"><code>clustermq</code></a> package provides an interface to multiple HPC schedulers (including Slurm) via the ZeroMQ socket library, available as a module assuming the prerequisite modules for R have already been loaded then;</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load ZeroMQ/4.3.4</span></code></pre></div>
<p>will load a compatible ZeroMQ module.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("clustermq") if you have not installed the package yet</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mschubert.github.io/clustermq/" class="external-link">clustermq</a></span><span class="op">)</span>

<span class="fu"><a href="https://mschubert.github.io/clustermq/reference/Q.html" class="external-link">Q</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, i<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, n_jobs<span class="op">=</span><span class="fl">5</span><span class="op">)</span></code></pre></div>
<p>The package relies on a <a href="https://github.com/mschubert/clustermq/blob/master/inst/SLURM.tmpl" class="external-link">submission template</a>, which by default submits Slurm jobs as a job array. As we need to supply an account name, and the policy on Sulis is to use tasks whenever possible, we should modify the submission template to:</p>
<ul>
<li>Include the right budgeting account</li>
<li>
<del>Use <code>srun</code> with multiple tasks per index in the job array</del> this is not actually working (yet)</li>
</ul>
<p>To address both points, we can create a new file <code>cmq_slurm.tmpl</code> with the following contents:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --account={{ account | su105 }}</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name={{ job_name }}</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-{{ n_jobs }}</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem-per-cpu={{ memory | 1024M }}</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task={{ cores | 1 }}</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load rjags/4-10-R-4.1.2 <span class="co"># this we will need for our example</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="va">CMQ_AUTH</span><span class="op">=</span>{{ <span class="ex">auth</span> }} R <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">'clustermq:::worker("{{ master }}")'</span></span></code></pre></div>
<p>We can then use this newly created template by:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>clustermq.host <span class="op">=</span> <span class="st">"ib0"</span>, <span class="co"># faster network</span>
        clustermq.template <span class="op">=</span> <span class="st">"/path/to/cmq_slurm.tmpl"</span><span class="op">)</span></code></pre></div>
<p>We can either run these lines in an active R session, or add them to <code>~/.Rprofile</code> to set automatically each time R is started.</p>
<p><del>This should make the above example run with 10 tasks per job requested.</del> More information on how to configure and use <code>clustermq</code> is available at the <a href="https://mschubert.github.io/clustermq/articles/userguide.html" class="external-link">User Guide vignette</a>.</p>
</div>
<div class="section level4">
<h4 id="exercise-2">Exercise<a class="anchor" aria-label="anchor" href="#exercise-2"></a>
</h4>
<ul>
<li>Run the above <code>mcp</code> example using one interactive “master” job (e.g. using the R integration with <code>nvim</code>) and
<ul>
<li>Run the workers with <code>slurmR</code>
</li>
<li>Run the workers with <code>clustermq</code>
</li>
</ul>
</li>
</ul>
<details><summary>
Solution <code>slurmR</code>
</summary><p>If not in an interactive job yet, start it using</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--account</span> su105 <span class="at">--ntasks</span><span class="op">=</span>1 <span class="at">--cpus-per-task</span><span class="op">=</span>1 <span class="at">--time</span> 6:00:00 <span class="at">--pty</span> <span class="va">$SHELL</span></span></code></pre></div>
<p>In <code>nvim</code> create the file <em>compute_breakpt_slurmR.r</em>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/USCbiostats/slurmR" class="external-link">slurmR</a></span><span class="op">)</span>

<span class="va">run_mcp</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lindeloev.github.io/mcp/" class="external-link">mcp</a></span><span class="op">)</span>
    <span class="co"># one unbroken segment, 2 segments with one break point, 3 segments 2 bps</span>
    <span class="va">mods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># fit all three models, select the best using leave-one-out</span>
    <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu">mcp</span><span class="fu">::</span><span class="fu"><a href="https://lindeloev.github.io/mcp/reference/mcp.html" class="external-link">mcp</a></span><span class="op">(</span><span class="va">m</span>, data<span class="op">=</span><span class="va">sim</span>, par_x<span class="op">=</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">compare</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="fu">mcp</span><span class="fu">::</span><span class="va"><a href="https://lindeloev.github.io/mcp/reference/criterion.html" class="external-link">loo</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">compare</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">fits</span><span class="op">[[</span><span class="va">best</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">dset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"sim_breakpt.rds"</span><span class="op">)</span>

<span class="va">cl</span> <span class="op">=</span> <span class="fu">makeSlurmCluster</span><span class="op">(</span><span class="fl">10</span>, account<span class="op">=</span><span class="st">"su105"</span><span class="op">)</span>
<span class="va">res</span> <span class="op">=</span> <span class="fu">parLapply</span><span class="op">(</span><span class="va">cl</span>, <span class="va">dset</span>, <span class="va">run_mcp</span><span class="op">)</span>
<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">res</span>, file<span class="op">=</span><span class="st">"breakpt_slurmR.rds"</span><span class="op">)</span></code></pre></div>
</details><details><summary>
Solution <code>clustermq</code>
</summary><p>If not in an interactive job yet, start it using</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">srun</span> <span class="at">--account</span> su105 <span class="at">--ntasks</span><span class="op">=</span>1 <span class="at">--cpus-per-task</span><span class="op">=</span>1 <span class="at">--time</span> 6:00:00 <span class="at">--pty</span> <span class="va">$SHELL</span></span></code></pre></div>
<p>In <code>nvim</code> create the file <em>compute_breakpt_clustermq.r</em>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mschubert.github.io/clustermq/" class="external-link">clustermq</a></span><span class="op">)</span>

<span class="va">run_mcp</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># one unbroken segment, 2 segments with one break point, 3 segments 2 bps</span>
    <span class="va">mods</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span>, <span class="op">~</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

    <span class="co"># fit all three models, select the best using leave-one-out</span>
    <span class="va">fits</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mods</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu">mcp</span><span class="fu">::</span><span class="fu"><a href="https://lindeloev.github.io/mcp/reference/mcp.html" class="external-link">mcp</a></span><span class="op">(</span><span class="va">m</span>, data<span class="op">=</span><span class="va">sim</span>, par_x<span class="op">=</span><span class="st">"x"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">compare</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="fu">mcp</span><span class="fu">::</span><span class="va"><a href="https://lindeloev.github.io/mcp/reference/criterion.html" class="external-link">loo</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"model"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">compare</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">fits</span><span class="op">[[</span><span class="va">best</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">dset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"sim_breakpt.rds"</span><span class="op">)</span>

<span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="https://mschubert.github.io/clustermq/reference/Q.html" class="external-link">Q</a></span><span class="op">(</span><span class="va">run_mcp</span>, sim<span class="op">=</span><span class="va">dset</span>, pkgs<span class="op">=</span><span class="st">"mcp"</span>, n_jobs<span class="op">=</span><span class="fl">10</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">res</span>, file<span class="op">=</span><span class="st">"breakpt_clustermq.rds"</span><span class="op">)</span></code></pre></div>
</details>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Schubert.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
